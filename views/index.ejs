  <div id="header_bar">
    <ul>
      <li><span class="active">Home</span></li>

      <li><a href="/static/time_ranking.html" target="_blank">Ranking</a></li>

      <li><a href="/signout">Sign out</a></li>
    </ul>
  </div>

  <ul id="controller">
    <li><a href="javascript:void(0);" id="back">&lt;&lt;BACK</a></li>
    <li><a href="javascript:void(0);" id="skip">SKIP &gt;&gt;</a></li>
  </ul>

  <div id="audio_player" class="jp-jplayer"></div>
  <div class="jp-audio">
    <div class="jp-type-single">
      <div id="jp_interface_1" class="jp-interface">
        <ul class="jp-controls">
          <li><a href="#" class="jp-play" tabindex="1">play</a></li>
       
          <li><a href="#" class="jp-pause" tabindex="1">pause</a></li>
       
          <li><a href="#" class="jp-stop" tabindex="1">stop</a></li>
       
          <li><a href="#" class="jp-mute" tabindex="1">mute</a></li>
       
          <li><a href="#" class="jp-unmute" tabindex=
          "1">unmute</a></li>
        </ul>

        <div class="jp-progress">
          <div class="jp-seek-bar">
             <div class="jp-play-bar"></div>
          </div>
        </div>
        
        <div class="jp-volume-bar">
           <div class="jp-volume-bar-value"></div>
        </div>
        
        <div class="jp-current-time"></div>
        
        <div class="jp-duration"></div>
      </div>
    </div>
  </div>
  
  <div class="block">
    <textarea class="inner" id="typing"></textarea>
  </div>
  <div id="result"></div>
<script type="text/javascript" src=
  "http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js">
</script><script type="text/javascript" src=
"http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js">
</script><script type="text/javascript" src=
"/javascripts/jquery.typing.min.js">
</script><script type="text/javascript" src=
"/javascripts/jquery.jplayer.min.js">
</script><script src="/javascripts/jquery.prettyPopin.js" type=
"text/javascript" charset="utf-8">
</script><script src="/javascripts/diff_match_patch.js" type=
"text/javascript">
</script><script src="/socket.io/socket.io.js" type=
"text/javascript">
</script><script type="text/javascript">
//<![CDATA[
  $(document).ready(function(){
    var studyTime = 0 ,typeStart = 0, volume = 0.5, play = 1 ,screenName = "<%= loggedIn ? session.user_profile.screen_name : '' %>";
    $('#typing')
    .attr("disabled","disabled")
    .val("Please input your answer and key press ENTER");
    if("" == screenName){
      $("<a href='/static/go_twitter.html' rel='prettyPopin'><\/a>")
      .prettyPopin({height:300,width: 550,followScroll:false})
      .click();
      return;
    }

    var doContents = function(status){
      document.location.hash = "!/contents/1/1/80/"+(status.contents+1);
      $("#result").html($("<span />"));
      $("#result").empty();
      $("#audio_player").jPlayer("stop");
      $("#contents").html("CLEAR:"+status.clear+"("+(status.contents+1)+"/80)");
      $("#audio_player").jPlayer("destroy");

      var move = function(status){
         stat.emit('skip',{
           "screen_name": screenName,
           "clear"      : status.clear,
           "miss"       : status.miss,
           "studyTime"  : studyTime,
           "contents"   : status.contents
         });
         $("#study_time").html('SKIP');
         $("#me")
         .clearQueue()
         .animate({backgroundColor:"#f0f",color:"#fff"},500)
         .animate({backgroundColor:"#fff",color:"#000"},500);
         doContents(status);
         play = 1;
         $("#play").html("PLAY:"+play);
      };
      $('#skip').unbind().click(function(){
         status.contents = (++status.contents)%80;
         move(status);
      });
      $('#back').unbind().click(function(){
         status.contents = 0 == status.contents ? 79 : --status.contents;
         move(status);
      });

      $('#typing').unbind().typing({
        start: function (event, $elem) {
            $("#result ins").css("color","#ddd").css("text-decoration","non").css("background-color","#ddd");
            $("#result del").remove();
            startTime = (new Date()).getTime();
            stat.emit('type start',{
              "screen_name": screenName,
              "clear"      : status.clear,
              "miss"       : status.miss,
              "studyTime"  : studyTime,
              "contents"   : status.contents
            });
            $elem.css('background', '#009be3')
            .css('color', '#fff');
        },
        stop: function (event, $elem) {
            $("#result ins").css("color","#ddd").css("text-decoration","non").css("background-color","#ddd");
            $("#result del").remove();
            studyTime += (new Date()).getTime() - startTime;
            stat.emit('type end',{
              "screen_name": screenName,
              "studyTime"  : studyTime,
              "clear"      : status.clear,
              "miss"       : status.miss,
              "contents"   : status.contents
            });
            var sec = parseInt(parseInt(studyTime)/1000);
            
            var hour= parseInt(sec/(60 * 60));
            if(hour > 0 ){sec    %= (hour * 60 * 60);}
            
            var min = parseInt(sec/60);
            if(min > 0 ){sec    %= (min * 60);}
            
            if(hour< 10){hour = "0"+hour};
            if(min < 10){min  = "0"+min};
            if(sec < 10){sec  = "0"+sec};
            $("#study_time").html('TIME: '+hour+":"+min+":"+sec);
            $elem.css('background', '#ddd')
            .css('color', '#666')
        },
        delay: 1000
      })
      .removeAttr("disabled")
      .val("")
      .focus()
      .keypress(function (e) {
        if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
          var $textarea = $(this);
          var dmp = new diff_match_patch();
          var d = dmp.diff_main($textarea.val(),contents[status.contents]);
          if("" != $textarea.val() && 1 == d.length){
            status.clear++;
            status.contents = (++status.contents)%80;
            stat.emit('clear',{
              "screen_name": screenName,
              "clear"      : status.clear,
              "miss"       : status.miss,
              "studyTime"  : studyTime,
              "contents"   : status.contents
            });
            $("#study_time").html('CLEAR!!:'+status.clear);
            $("#me")
            .clearQueue()
            .animate({backgroundColor:"#0f0",color:"#fff"},500)
            .animate({backgroundColor:"#fff",color:"#000"},500);
            doContents(status);
          }else{
            dmp.diff_cleanupEfficiency(d);
            $("#result").html(dmp.diff_prettyHtml(d));
            status.miss++;
            stat.emit('miss',{
              "screen_name": screenName,
              "miss"       : status.miss,
              "clear"      : status.clear,
              "studyTime"  : studyTime,
              "contents"   : status.contents
            });
            $("#study_time").html('MISS!!: '+status.miss);
            $("#me")
            .clearQueue()
            .animate({backgroundColor:"#f00",color:"#fff"},500)
            .animate({backgroundColor:"#fff",color:"#000"},500);
          }
          return false;
        }
      })
      .bind("blur", function() {
        var $textarea = $(this),
            text = $textarea.val(),
            new_text = text.replace(/[\r\n ]+/g, " ");
        if (new_text != text) {
            $textarea.val(new_text);
        }
      });
      $("#audio_player").unbind().jPlayer({
         ready : function(){
          $(this).jPlayer("setMedia",{ 
             mp3: "/sounds/"+(status.contents+1)+".mp3"
          }).jPlayer("play");
         },
         preload: "auto",
         volume: volume,
         muted: false,
         backgroundColor: "#eee",
         errorAlerts:false,
         warningAlerts:false,
         ended: function (event) {
            $(this).jPlayer("play");
            play++;
            $("#play").html("PLAY:"+play);
         },
         swfPath: "/swfs/",
         solution: 'flash,html',
         supplied: "mp3, m4a, oga"
      })
      .bind($.jPlayer.event.play, function() {
         $(this).jPlayer("pauseOthers");
      })
      .bind($.jPlayer.event.volumechange, function(event) {
         volume = event.jPlayer.status.volume;
      });
    };
      
    var stat = io.connect('http://<%= title %>/status', {transports: ["xhr-polling"],port: 80 });
    stat.on('connect', function() {
      stat.emit('signin',{
        "screen_name": screenName,
        "clear"  : 0,
        "miss"   : 0,
        "studyTime"  : 0,
        "contents"  : 0
      });
      var signin = function(msg){
        var member = 
        $('<li class="other clearfix"/>')
        .attr("id",msg.id)
        .append($("<a />")
        .attr("href","#!/"+msg.screen_name)
        .append($("<img />")
        .attr("src","http://api.twitter.com/1/users/profile_image/"+msg.screen_name+"?size=normal"))
        .append($("<ul />")
          .append($("<li />")
          .attr("id","screen_name"+msg.id)
          .html("@"+msg.screen_name))
          .append($("<li />")
          .attr("id","status"+msg.id))
          .append($("<li />")
          .attr("id","contents"+msg.id))
        ));
        $("#members").append(member);
        member
        .clearQueue()
        .animate({backgroundColor:"#fdf",color:"#fff"},500)
        .animate({backgroundColor:"#fff",color:"#000"},500);
      };
      var updateStatus = function(msg,color){
        var member = $("#"+msg.id);
        var member_status   = $("#status"+msg.id);
        var member_contents = $("#contents"+msg.id);
        if(member.length > 0 && member_status.length > 0){
          member_status.html(msg.status);
          member_contents.html(""+msg.clear+"("+(msg.contents+1)+"/80)");
          if(null != color){
            member
            .clearQueue()
            .animate({backgroundColor:color,color:"#fff"},500)
            .animate({backgroundColor:"#fff",color:"#000"},500);
          }
        } else {
          signin(msg);
        }
      };
      stat.on('signin', function (msg) {
        signin(msg);
      });
      stat.on('signout', function (msg) {
        var signout = $("#"+msg.id);
        if(signout){signout.remove();}
      });
      stat.on('miss', function (msg) {
        updateStatus(msg,"#f00");
      });
      stat.on('clear', function (msg) {
        updateStatus(msg,"#0f0");
      });
      stat.on('skip', function (msg) {
        updateStatus(msg,"#f0f");
      });
      stat.on('type start', function (msg) {
        updateStatus(msg,null);
      });
      stat.on('type end', function (msg) {
        updateStatus(msg,null);
      });
      var contents=0;
      if(match = document.location.hash.match(/^#!\/contents\/1\/1\/80\/([0-9]+)$/)){
         if(2 == match.length && 1 <= match[1] && match[1] <= 80){ 
           contents = parseInt(match[1])-1;
         }
      }
      doContents({
        "miss":0,
        "clear":0,
        "contents":contents
      });
    });
    var contents = [
      "Who cooked this? I did.",
      "I went to the library yesterday.",
      "Does he know where to go? Yes, he does.",
      "How long have you lived in this country?",
      "Ellen may be angry.",
      "Will you please pass me the salt? Sure.",
      "They began to sing then.",
      "They all know the truth.",
      "My wife wants to go on a trip to Kyoto.",
      "Do I have to read this book? Yes, you do.",
      "Is your son tall? Yes, he is.",
      "Does your sister often go there? Yes, she does.",
      "Please show us the picture.",
      "Does he work here? No, he doesn't.",
      "Is she your sister? No, she isn't.",
      "Jump as high as you can.",
      "Didn't you study last week? Yes, I did.",
      "I don't know why he studies German.",
      "Didn't you come here yesterday? No, I didn't.",
      "Are most junior high school students taught English in Japan? Yes, they are.",
      "At last he got angry.",
      "The teacher likes students who study hard.",
      "Wasn't he in his room? No, he wasn't.",
      "I made him with the book.",
      "How tall those boys are.",
      "He went to the park to see her.",
      "They heard her cry.",
      "My mother likes singing.",
      "He hasn't eaten lunch yet.",
      "Is your father a doctor? Yes, he is.",
      "Studying foreign languages is interesting.",
      "Study harder, or you will fail the examination.",
      "How many cups of coffee do you drink a day?",
      "Does your dog eat fish?",
      "It must be snowing in New York.",
      "Doesn't he speak Japanese? No, he doesn't.",
      "How bright that star is.",
      "Tom is the smartest in the class.",
      "She believed that he was rich.",
      "Bob may still be sleeping.",
      "She likes cooking for her family.",
      "How old is he? He is twenty years old.",
      "I don't know how old she is.",
      "Look at that broken window.",
      "The girl playing the piano is Mary.",
      "Can't he play the guitar? Yes, he can.",
      "They have been married for ten years.",
      "I found the book very interesting.",
      "It was fine when they left.",
      "Do you have anything to write with?",
      "What time was it when he came back?",
      "The boy whose uncle is American is good at English.",
      "He is rich enough to travel abroad every year.",
      "She may be sad.",
      "Isn't your wife Japanese? No, she isn't.",
      "How did you learn Chinese?",
      "My brother has been studying mathematics since he got up.",
      "Do you see the room the window of which is open?",
      "The woman watched TV while her husband was washing the dishes.",
      "She is too young to live alone.",
      "Your grandmother will be glad to see you.",
      "Do you think that it will rain in the afternoon?",
      "What is cheese made from?",
      "Are those girls his daughters? Yes, they are.",
      "Call him, or he will get angry.",
      "Aren't they angry? No, they aren't.",
      "Do you keep your room clean? Yes, I do.",
      "Do you have to buy all these books?",
      "He is as smart as you.",
      "You are tired, aren't you?",
      "The garden is covered with flowers.",
      "Why did you drink so much coffee?",
      "I have just cleaned my room.",
      "Have you ever been spoken to by a foreigner?",
      "The old man likes taking a walk along the river after breakfast.",
      "She thinks that she is right.",
      "By whom is this cat taken care of?",
      "Haven't you done your homework yet? No, I haven't.",
      "He had his daughter make some coffee.",
      "My mother always tells me to be more careful."
    ];
  });
  //]]>
  </script>
